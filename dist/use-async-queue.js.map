{"version":3,"file":"use-async-queue.js","sources":["../use-async-queue.ts"],"sourcesContent":["import { useState, useRef, useCallback, useEffect } from \"react\";\nimport nextTick from \"next-tick\";\n\ninterface QueueStats {\n  numPending: number;\n  numInFlight: number;\n  numDone: number;\n}\n\nexport interface QueueTaskResult {\n  id: unknown;\n  task(): Promise<unknown>;\n  result?: Promise<unknown>;\n  stats?: QueueStats;\n}\n\ninterface Queue {\n  add: (task: QueueTaskResult) => void;\n  stats: QueueStats;\n}\n\ninterface QueueOpts {\n  concurrency?: number;\n  done?: (result: QueueTaskResult) => void;\n  drain?: () => void;\n  inflight?: (task: QueueTaskResult) => void;\n}\n\nfunction useAsyncQueue(opts: QueueOpts): Queue {\n  const { done, drain, inflight } = opts;\n  let { concurrency } = opts;\n  concurrency = concurrency || Infinity;\n  if (concurrency < 1) concurrency = Infinity;\n\n  const [stats, setStats] = useState({\n    numPending: 0,\n    numInFlight: 0,\n    numDone: 0,\n  });\n\n  const drained = useRef(true);\n  const inFlight = useRef([] as QueueTaskResult[]);\n  const pending = useRef([] as QueueTaskResult[]);\n\n  useEffect(() => {\n    if (\n      stats.numDone > 0 &&\n      drain &&\n      inFlight.current.length === 0 &&\n      pending.current.length === 0 &&\n      !drained.current\n    ) {\n      drained.current = true;\n      return nextTick(drain);\n    }\n\n    while (\n      inFlight.current.length < concurrency! &&\n      pending.current.length > 0\n    ) {\n      drained.current = false;\n      const task = pending.current.shift();\n      if (task) {\n        inFlight.current.push(task);\n        setStats((stats) => {\n          return {\n            ...stats,\n            numPending: stats.numPending - 1,\n            numInFlight: stats.numInFlight + 1,\n          };\n        });\n        inflight && inflight({ ...task, stats });\n        const result = task.task();\n        result\n          .then(() => {\n            inFlight.current.pop();\n            setStats((stats) => {\n              return {\n                ...stats,\n                numInFlight: stats.numInFlight - 1,\n                numDone: stats.numDone + 1,\n              };\n            });\n            done && done({ ...task, result, stats });\n          })\n          .catch(() => {\n            inFlight.current.pop();\n            setStats((stats) => {\n              return {\n                ...stats,\n                numInFlight: stats.numInFlight - 1,\n                numDone: stats.numDone + 1,\n              };\n            });\n            done && done({ ...task, result, stats });\n          });\n      }\n    }\n  }, [concurrency, done, drain, inflight, stats]);\n\n  const add = useCallback((task: QueueTaskResult) => {\n    if (\n      !pending.current.find((t) => {\n        return t.id === task.id;\n      }) &&\n      !inFlight.current.find((t) => {\n        return t.id === task.id;\n      })\n    ) {\n      pending.current.push(task);\n      setStats((stats) => {\n        return {\n          ...stats,\n          numPending: stats.numPending + 1,\n        };\n      });\n    }\n  }, []);\n\n  return { add, stats };\n}\n\nexport default useAsyncQueue;\n"],"names":["opts","done","drain","inflight","concurrency","Infinity","stats","setStats","useState","numPending","numInFlight","numDone","drained","useRef","inFlight","pending","useEffect","current","length","nextTick","task","shift","push","result","then","pop","catch","add","useCallback","find","t","id"],"mappings":"yJA4BA,SAAuBA,GACrB,MAAMC,KAAEA,EAAIC,MAAEA,EAAKC,SAAEA,GAAaH,EAClC,IAAII,YAAEA,GAAgBJ,EACtBI,EAAcA,GAAeC,SACzBD,EAAc,IAAGA,EAAcC,UAEnC,MAAOC,EAAOC,GAAYC,EAAQA,SAAC,CACjCC,WAAY,EACZC,YAAa,EACbC,QAAS,IAGLC,EAAUC,EAAAA,QAAO,GACjBC,EAAWD,EAAMA,OAAC,IAClBE,EAAUF,EAAAA,OAAO,IA6EvB,OA3EAG,EAAAA,UAAU,KACR,GACEV,EAAMK,QAAU,GAChBT,GAC4B,IAA5BY,EAASG,QAAQC,QACU,IAA3BH,EAAQE,QAAQC,SACfN,EAAQK,QAGT,OADAL,EAAQK,SAAU,EACXE,EAAQ,QAACjB,GAGlB,KACEY,EAASG,QAAQC,OAASd,GAC1BW,EAAQE,QAAQC,OAAS,GACzB,CACAN,EAAQK,SAAU,EAClB,MAAMG,EAAOL,EAAQE,QAAQI,QAC7B,GAAID,EAAM,CACRN,EAASG,QAAQK,KAAKF,GACtBb,EAAUD,IACD,IACFA,EACHG,WAAYH,EAAMG,WAAa,EAC/BC,YAAaJ,EAAMI,YAAc,KAGrCP,GAAYA,EAAS,IAAKiB,EAAMd,UAChC,MAAMiB,EAASH,EAAKA,OACpBG,EACGC,KAAK,KACJV,EAASG,QAAQQ,MACjBlB,EAAUD,IACD,IACFA,EACHI,YAAaJ,EAAMI,YAAc,EACjCC,QAASL,EAAMK,QAAU,KAG7BV,GAAQA,EAAK,IAAKmB,EAAMG,SAAQjB,SAClC,GACCoB,MAAM,KACLZ,EAASG,QAAQQ,MACjBlB,EAAUD,IACD,IACFA,EACHI,YAAaJ,EAAMI,YAAc,EACjCC,QAASL,EAAMK,QAAU,KAG7BV,GAAQA,EAAK,IAAKmB,EAAMG,SAAQjB,WAEtC,CACF,GACC,CAACF,EAAaH,EAAMC,EAAOC,EAAUG,IAqBjC,CAAEqB,IAnBGC,EAAAA,YAAaR,IAEpBL,EAAQE,QAAQY,KAAMC,GACdA,EAAEC,KAAOX,EAAKW,KAEtBjB,EAASG,QAAQY,KAAMC,GACfA,EAAEC,KAAOX,EAAKW,MAGvBhB,EAAQE,QAAQK,KAAKF,GACrBb,EAAUD,IACD,IACFA,EACHG,WAAYH,EAAMG,WAAa,KAGrC,EACC,IAEWH,QAChB"}